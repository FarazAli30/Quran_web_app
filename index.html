<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>القرآن الكريم</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@400;500;700&family=Lateef&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Font Variables */
      --font-ui: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --arabic-font-family: 'Scheherazade New', serif;
      --arabic-font-size: 1.6rem;
      --urdu-font-size: 1rem;

      /* Light Mode Colors */
      --color-bg: #f4f7f6;
      --color-bg-alt: #ffffff;
      --color-text: #212529;
      --color-text-muted: #5a6a7a;
      --color-primary: #198754;
      --color-primary-light: #d1e7dd;
      --color-primary-text: #ffffff;
      --color-border: #dee2e6;
      --color-shadow: rgba(0, 0, 0, 0.05);
      --color-shadow-lg: rgba(0, 0, 0, 0.1);
      --color-shadow-top: rgba(0, 0, 0, 0.08);
      --color-ayah-selected-border: #0d6efd;
      --color-ayah-selected-bg: #e2eafc;
      --color-ayah-playing-border: #198754;
      --color-ayah-playing-bg: #d1e7dd;

      /* Transitions */
      --transition-fast: all 0.2s ease;
      --transition-slow: all 0.3s ease;
    }

    body.dark-mode {
      /* Dark Mode Colors */
      --color-bg: #121212;
      --color-bg-alt: #1e1e1e;
      --color-text: #e0e0e0;
      --color-text-muted: #9a9a9a;
      --color-primary: #2a9d8f;
      --color-primary-light: #2c3e3a;
      --color-primary-text: #ffffff;
      --color-border: #343a40;
      --color-shadow: rgba(255, 255, 255, 0.03);
      --color-shadow-lg: rgba(255, 255, 255, 0.05);
      --color-shadow-top: rgba(255, 255, 255, 0.1);
      --color-ayah-selected-border: #58a6ff;
      --color-ayah-selected-bg: #2a3a5c;
      --color-ayah-playing-border: #2a9d8f;
      --color-ayah-playing-bg: #2a4a3d;
    }

    /* Base Styles */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-ui);
      background-color: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      padding: 0;
      direction: ltr; /* UI is LTR, content is RTL */
      transition: var(--transition-slow);
      padding-top: 120px; /* Space for sticky headers */
      padding-bottom: 150px; /* Space for sticky audio player */
    }

    /* Main Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: var(--color-bg-alt);
      box-shadow: 0 2px 10px var(--color-shadow-lg);
      transition: var(--transition-slow);
      direction: ltr;
    }
    
    #header-title {
        font-family: 'Amiri', serif;
        font-size: 2rem;
        color: var(--color-primary);
        margin: 0;
        direction: rtl; /* Title itself is RTL */
    }
    
    #header-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* All icon buttons */
    .icon-btn {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-fast);
    }
    .icon-btn:hover {
        background-color: var(--color-shadow-lg);
        color: var(--color-text);
    }
    .icon-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

    /* Dark mode toggle animation */
    #dark-mode-toggle {
        font-size: 1.5rem;
        line-height: 1;
    }
    .dark-mode #sun-icon { display: inline-block; }
    .dark-mode #moon-icon { display: none; }
    #sun-icon { display: none; }
    #moon-icon { display: inline-block; }

    /* Sticky Surah Navigation */
    #surah-nav-sticky-wrapper {
        position: fixed;
        top: 68px; /* Header height */
        left: 0;
        right: 0;
        z-index: 99;
        background: var(--color-bg);
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 5px var(--color-shadow);
        transition: var(--transition-slow);
        direction: ltr;
    }
    #surah-nav-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        max-width: 800px;
        margin: 0 auto;
    }
    
    #surah-nav-controls button {
        background-color: var(--color-bg-alt);
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 99px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-fast);
        box-shadow: 0 1px 3px var(--color-shadow);
    }
    #surah-nav-controls button:hover {
        background-color: var(--color-primary);
        color: var(--color-primary-text);
        transform: scale(1.05);
    }
    #surah-nav-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        background-color: var(--color-shadow);
        border-color: var(--color-border);
        color: var(--color-text-muted);
    }
    
    /* Styled Select Menu */
    #surah-select-wrapper {
        flex-grow: 1;
        position: relative;
    }
    #surah-select {
        width: 100%;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 0.5rem 2.5rem 0.5rem 1rem;
        font-size: 1rem;
        font-family: var(--font-ui);
        color: var(--color-text);
        cursor: pointer;
        transition: var(--transition-fast);
    }
    #surah-select:hover {
        border-color: var(--color-primary);
    }
    #surah-select-wrapper::after {
        content: '▼';
        position: absolute;
        top: 50%;
        right: 1rem;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        pointer-events: none;
    }

    /* Main Content Area */
    main {
        padding: 1rem;
    }

    /* Random Ayah Widget & Ayah Cards */
    #random-ayah-widget, .ayah {
        background-color: var(--color-bg-alt);
        margin: 1.5rem auto;
        padding: 1.5rem;
        width: 95%;
        max-width: 800px;
        box-shadow: 0 4px 15px var(--color-shadow-lg);
        border-radius: 12px;
        transition: var(--transition-slow);
        border: 2px solid transparent;
        direction: rtl;
        /* Animation */
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.5s ease forwards;
    }
    
    /* Staggered animation for Ayahs */
    .ayah {
        animation-delay: calc(var(--i, 0) * 30ms);
    }
    
    @keyframes fadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #random-ayah-widget {
        border: 2px solid var(--color-primary);
        text-align: center;
    }
    #random-ayah-widget h3 {
        margin-top: 0;
        color: var(--color-primary);
        font-family: var(--font-ui);
        font-weight: 700;
        direction: ltr;
    }
    
    .ayah:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px var(--color-shadow-lg);
    }
    .ayah.selected {
      border-color: var(--color-ayah-selected-border);
      background-color: var(--color-ayah-selected-bg);
    }
    .playing {
      border-color: var(--color-ayah-playing-border);
      background-color: var(--color-ayah-playing-bg);
      box-shadow: 0 0 15px var(--color-ayah-playing-border);
    }

    .verse-number {
      color: var(--color-primary);
      font-weight: bold;
      font-family: var(--font-ui);
      font-size: 0.9rem;
    }
    .arabic {
      font-size: var(--arabic-font-size);
      font-family: var(--arabic-font-family);
      margin-top: 0.5rem;
      line-height: 2;
    }
    .urdu {
      color: var(--color-text-muted);
      font-size: var(--urdu-font-size);
      font-family: var(--font-ui); /* Or a specific Urdu font like 'Noto Nastaliq Urdu' */
      margin-top: 1rem;
      display: none;
      line-height: 1.8;
    }
    
    /* Settings Panel */
    #overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1001;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    #settings-panel {
        position: fixed;
        top: 0;
        right: -320px; /* Start off-screen */
        width: 300px;
        height: 100%;
        background-color: var(--color-bg);
        z-index: 1002;
        box-shadow: -5px 0 20px rgba(0,0,0,0.1);
        padding: 1.5rem;
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        direction: ltr;
    }
    
    #settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    #settings-header h2 {
        margin: 0;
        color: var(--color-primary);
    }
    
    .settings-group {
        margin-bottom: 1.5rem;
    }
    .settings-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--color-text-muted);
        margin-bottom: 0.5rem;
    }
    .settings-group select, .settings-group input[type="range"] {
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
        background-color: var(--color-bg-alt);
        color: var(--color-text);
        font-family: var(--font-ui);
    }
    
    .settings-group .toggle-btn-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--color-bg-alt);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }
    .toggle-btn-wrapper span {
        font-weight: 500;
    }
    /* Simple toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--color-primary);
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }

    /* Open state for settings */
    body.settings-panel-open #overlay {
        opacity: 1;
        pointer-events: auto;
    }
    body.settings-panel-open #settings-panel {
        transform: translateX(-320px);
    }

    /* Sticky Audio Player Bar */
    #audio-player-bar {
        position: fixed;
        bottom: -100px; /* Start off-screen */
        left: 0;
        right: 0;
        z-index: 98;
        background-color: var(--color-bg-alt);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        box-shadow: 0 -5px 20px var(--color-shadow-top);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        direction: ltr;
    }
    #audio-player-bar.visible {
        transform: translateY(-100px);
    }
    
    #audio-status {
        font-size: 0.9rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    #audio-player-buttons {
        display: flex;
        gap: 0.5rem;
    }
    #audio-player-buttons button {
        background-color: var(--color-primary);
        color: var(--color-primary-text);
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-fast);
        box-shadow: 0 2px 5px var(--color-shadow-lg);
    }
    #audio-player-buttons button:hover {
        transform: scale(1.1);
        filter: brightness(1.1);
    }
    #audio-player-buttons button:disabled {
        background-color: var(--color-border);
        color: var(--color-text-muted);
        transform: none;
        filter: none;
        cursor: not-allowed;
    }
    #pauseResumeBtn {
        display: none; /* Hide by default, show when playing */
    }
    body.is-playing #playSurahBtn {
        display: none;
    }
    body.is-playing #pauseResumeBtn {
        display: inline-flex;
    }

    /* CSS Loading Spinner */
    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 3rem 1rem 1rem;
      background-color: var(--color-bg);
      color: var(--color-text-muted);
      direction: ltr;
      font-size: 0.9rem;
    }
    .footer-content {
      max-width: 600px;
      margin: 0 auto;
    }
    .social-links {
      margin-top: 1rem;
    }
    .social-links a {
      margin: 0 10px;
      color: var(--color-text-muted);
      display: inline-block;
      transition: var(--transition-fast);
    }
    .social-links a:hover {
        color: var(--color-primary);
        transform: scale(1.1);
    }
    .social-links svg {
      width: 28px;
      height: 28px;
      fill: currentColor;
    }
    
    @media (max-width: 480px) {
        body {
            padding-top: 110px; /* Less padding for smaller header */
        }
        header {
            padding: 0.5rem 0.75rem;
        }
        #header-title {
            font-size: 1.5rem;
        }
        .icon-btn svg {
            width: 20px;
            height: 20px;
        }
        #surah-nav-sticky-wrapper {
            top: 56px; /* Adjust for smaller header */
            padding: 0.5rem;
        }
        #surah-nav-controls button {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
        }
        #surah-select {
            font-size: 0.9rem;
        }
        main {
            padding: 0.5rem;
        }
        #random-ayah-widget, .ayah {
            padding: 1rem;
            margin: 1rem auto;
        }
        .arabic {
            font-size: calc(var(--arabic-font-size) * 0.9);
            line-height: 1.9;
        }
        #audio-player-bar {
            padding: 0.75rem 1rem;
        }
        #audio-status {
            font-size: 0.8rem;
        }
        #audio-player-buttons button {
            width: 40px;
            height: 40px;
        }
        #settings-panel {
            width: 280px;
            right: -280px;
        }
        body.settings-panel-open #settings-panel {
            transform: translateX(-280px);
        }
    }

  </style>
</head>
<body>

  <!-- Settings Panel (hidden by default) -->
  <div id="overlay"></div>
  <div id="settings-panel">
    <div id="settings-header">
        <h2>Settings</h2>
        <button id="close-settings-btn" class="icon-btn" title="Close Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
    </div>
    
    <div class="settings-group">
        <label for="arabic-font-select">Arabic Font</label>
        <select id="arabic-font-select">
            <option value="'Scheherazade New', serif">Scheherazade</option>
            <option value="'Amiri', serif">Amiri</option>
            <option value="'Lateef', cursive">Lateef</option>
        </select>
    </div>
    
    <div class="settings-group">
        <label for="zoom-slider">Arabic Font Size</label>
        <input type="range" id="zoom-slider" min="1.2" max="3.0" step="0.1" value="1.6" title="Adjust Arabic Font Size">
    </div>
    
    <div class="settings-group">
        <label for="urdu-font-size-select">Urdu/Eng Size</label>
        <select id="urdu-font-size-select">
            <option value="0.8rem">Small</option>
            <option value="1.0rem" selected>Medium</option>
            <option value="1.2rem">Large</option>
        </select>
    </div>
    
    <div class="settings-group">
        <div class="toggle-btn-wrapper">
            <span>📖 Urdu Translation</span>
            <label class="switch">
              <input type="checkbox" id="translation-toggle" onclick="toggleTranslation()">
              <span class="slider"></span>
            </label>
        </div>
    </div>
  </div>

  <!-- Main Header -->
  <header>
    <h1 id="header-title">القرآن الكريم</h1>
    <div id="header-controls">
        <button id="dark-mode-toggle" class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark/Light Mode">
            <span id="moon-icon">🌙</span>
            <span id="sun-icon">☀️</span>
        </button>
        <button id="settings-toggle" class="icon-btn" title="Open Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
        </button>
    </div>
  </header>

  <!-- Sticky Surah Navigation -->
  <div id="surah-nav-sticky-wrapper">
    <div id="surah-nav-controls">
      <button id="prev-surah" onclick="showPreviousSurah()" disabled>⏮️ Prev</button>
      <div id="surah-select-wrapper">
        <select id="surah-select"></select>
      </div>
      <button id="next-surah" onclick="showNextSurah()" disabled>Next ⏭️</button>
    </div>
  </div>

  <!-- Main Content (Scrollable) -->
  <main id="verse-container">
    <!-- Daily Random Ayah Widget or Surah content will be injected here -->
  </main>

  <!-- Sticky Audio Player (Bottom) -->
  <div id="audio-player-bar">
    <div id="audio-status">Welcome! Select a Surah to begin.</div>
    <div id="audio-player-buttons">
      <button id="playSurahBtn" title="Play Surah">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="pauseResumeBtn" title="Pause/Resume">
        <!-- Will be dynamically filled with Play/Pause icon -->
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>Developed with ❤️ for Quran readers</p>
      <div class="social-links">
        <a href="https://github.com/FarazAli30" target="_blank" title="GitHub Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
        <a href="https://www.linkedin.com/in/farazalikhushk?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" title="LinkedIn Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        </a>
      </div>
    </div>
  </footer>

  <!-- SVG Icons for Player -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <symbol id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></symbol>
      <symbol id="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></symbol>
    </defs>
  </svg>

  <script>
    // Global variables
    let showTranslation = false;
    let quranData = [];
    let quranUrData = [];
    let currentSurahIndex = -1; // -1 indicates no surah selected
    let reciterNo = 2;
    let audio = new Audio();
    let currentAyah = 1;
    let isPaused = false;
    let selectedAyah = null;
    let dbPromise; // For IndexedDB

    // DOM Elements
    const dom = {
        settingsPanel: document.getElementById('settings-panel'),
        overlay: document.getElementById('overlay'),
        settingsToggle: document.getElementById('settings-toggle'),
        closeSettingsBtn: document.getElementById('close-settings-btn'),
        audioPlayerBar: document.getElementById('audio-player-bar'),
        audioStatus: document.getElementById('audio-status'),
        playSurahBtn: document.getElementById('playSurahBtn'),
        pauseResumeBtn: document.getElementById('pauseResumeBtn'),
        translationToggle: document.getElementById('translation-toggle')
    };
    
    // SVG Icons
    const icons = {
        play: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M8 5v14l11-7z"/></svg>',
        pause: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'
    };

    document.addEventListener('DOMContentLoaded', () => {
      initDB();
      applySavedSettings();
      loadQuran();
      setupEventListeners();
    });

    // --- IndexedDB Functions for Audio Caching ---
    function initDB() {
      dbPromise = new Promise((resolve, reject) => {
        if (!('indexedDB' in window)) {
          console.warn('IndexedDB not supported. Offline audio will not be available.');
          return reject('IndexedDB not supported');
        }
        const request = indexedDB.open('QuranAudioCacheDB', 1);
        request.onerror = (event) => reject('IndexedDB error');
        request.onsuccess = (event) => resolve(event.target.result);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('audioCache')) {
            db.createObjectStore('audioCache', { keyPath: 'id' });
          }
        };
      });
    }

    async function saveAudioToCache(id, blob) {
      try {
        const db = await dbPromise;
        const transaction = db.transaction(['audioCache'], 'readwrite');
        const store = transaction.objectStore('audioCache');
        store.put({ id: id, blob: blob });
        return new Promise((resolve, reject) => {
            transaction.oncomplete = () => resolve(true);
            transaction.onerror = (event) => reject(event.target.error);
        });
      } catch (error) {
        console.error('Failed to save audio to cache:', error);
      }
    }

    async function getAudioFromCache(id) {
      try {
        const db = await dbPromise;
        const transaction = db.transaction(['audioCache'], 'readonly');
        const store = transaction.objectStore('audioCache');
        const request = store.get(id);
        return new Promise((resolve, reject) => {
          request.onsuccess = (event) => resolve(event.target.result ? event.target.result.blob : null);
          request.onerror = (event) => reject(event.target.error);
        });
      } catch (error) {
        console.error('Failed to get audio from cache:', error);
        return null;
      }
    }

    // --- Settings & UI ---

    function setupEventListeners() {
        // Settings Panel
        dom.settingsToggle.addEventListener('click', () => document.body.classList.add('settings-panel-open'));
        dom.closeSettingsBtn.addEventListener('click', () => document.body.classList.remove('settings-panel-open'));
        dom.overlay.addEventListener('click', () => document.body.classList.remove('settings-panel-open'));

        // Font Controls
        document.getElementById('arabic-font-select').addEventListener('change', (e) => changeArabicFont(e.target.value));
        document.getElementById('urdu-font-size-select').addEventListener('change', (e) => changeUrduFontSize(e.target.value));
        document.getElementById('zoom-slider').addEventListener('input', (e) => changeArabicFontSize(e.target.value));

        // Audio Player
        dom.playSurahBtn.addEventListener('click', playSurahAudio);
        dom.pauseResumeBtn.addEventListener('click', togglePause);
    }

    function applySavedSettings() {
      // Dark Mode
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) document.body.classList.add('dark-mode');

      // Arabic Font
      const arabicFont = localStorage.getItem('arabicFont') || "'Scheherazade New', serif";
      document.documentElement.style.setProperty('--arabic-font-family', arabicFont);
      document.getElementById('arabic-font-select').value = arabicFont;
      
      // Arabic Font Size
      const arabicSize = localStorage.getItem('arabicFontSize') || '1.6';
      document.documentElement.style.setProperty('--arabic-font-size', `${arabicSize}rem`);
      document.getElementById('zoom-slider').value = arabicSize;
      
      // Urdu Font Size
      const urduSize = localStorage.getItem('urduFontSize') || '1.0rem';
      document.documentElement.style.setProperty('--urdu-font-size', urduSize);
      document.getElementById('urdu-font-size-select').value = urduSize;
      
      // Translation
      showTranslation = localStorage.getItem('showTranslation') === 'true';
      dom.translationToggle.checked = showTranslation;
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function changeArabicFont(fontFamily) {
      document.documentElement.style.setProperty('--arabic-font-family', fontFamily);
      localStorage.setItem('arabicFont', fontFamily);
    }
    
    function changeArabicFontSize(size) {
        document.documentElement.style.setProperty('--arabic-font-size', `${size}rem`);
        localStorage.setItem('arabicFontSize', size);
    }
    
    function changeUrduFontSize(fontSize) {
      document.documentElement.style.setProperty('--urdu-font-size', fontSize);
      localStorage.setItem('urduFontSize', fontSize);
    }
    
    function toggleTranslation() {
      showTranslation = !showTranslation;
      localStorage.setItem('showTranslation', showTranslation);
      document.querySelectorAll(".urdu").forEach(el => {
          el.style.display = showTranslation ? "block" : "none";
      });
    }

    // --- Core App Logic ---

    async function loadQuran() {
      try {
          const [arRes, urRes] = await Promise.all([
            fetch("./data/quran.json"),
            fetch("./data/quran_ur.json")
          ]);
          if (!arRes.ok || !urRes.ok) throw new Error('Failed to load Quran data.');
          
          quranData = await arRes.json();
          quranUrData = await urRes.json();
          
          populateSurahList();
          showRandomAyah(); // Show random Ayah on load
      } catch (error) {
          console.error('Error loading Quran data:', error);
          document.getElementById('verse-container').innerHTML = 
            '<p style="text-align:center; color:red;">Failed to load Quran data. Please check your connection and try again.</p>';
      }
    }

    function populateSurahList() {
      const select = document.getElementById("surah-select");
      
      const placeholderOpt = document.createElement("option");
      placeholderOpt.value = "";
      placeholderOpt.textContent = "Select a Surah...";
      placeholderOpt.disabled = true;
      placeholderOpt.selected = true;
      select.appendChild(placeholderOpt);

      quranData.forEach((surah, index) => {
        const opt = document.createElement("option");
        opt.value = index;
        opt.textContent = `${surah.id}. ${surah.name} (${surah.transliteration})`;
        select.appendChild(opt);
      });
      select.addEventListener("change", () => {
        if (select.value !== "") {
            currentSurahIndex = parseInt(select.value);
            showSurah(currentSurahIndex);
        }
      });
    }
    
    function showRandomAyah() {
        const container = document.getElementById("verse-container");
        container.innerHTML = ""; // Clear previous content
        
        // Hide audio player, disable nav buttons
        dom.audioPlayerBar.classList.remove('visible');
        document.getElementById('prev-surah').disabled = true;
        document.getElementById('next-surah').disabled = true;

        const randomSurahIndex = Math.floor(Math.random() * quranData.length);
        const surah = quranData[randomSurahIndex];
        const surahUr = quranUrData[randomSurahIndex];
        
        const randomAyahIndex = Math.floor(Math.random() * surah.verses.length);
        const verse = surah.verses[randomAyahIndex];
        const verseUr = surahUr.verses[randomAyahIndex];
        
        const ayahNumber = randomAyahIndex + 1;
        const reference = `${surah.transliteration} (${surah.id}:${ayahNumber})`;

        container.innerHTML = `
            <div id="random-ayah-widget">
                <h3>Ayah of the Day</h3>
                <div id="random-ayah-arabic" class="arabic">${verse.text}</div>
                <div id="random-ayah-urdu" class="urdu" style="display: block;">${verseUr.translation}</div>
                <div id="random-ayah-ref" style="margin-top: 1rem; direction: ltr;">${reference}</div>
            </div>
        `;
    }
    
    function showNextSurah() {
        if (currentSurahIndex === -1) currentSurahIndex = 0;
        else if (currentSurahIndex < quranData.length - 1) currentSurahIndex++;
        else currentSurahIndex = 0; // Wrap to first
        updateSurahSelection(currentSurahIndex);
    }

    function showPreviousSurah() {
        if (currentSurahIndex === -1) currentSurahIndex = 0;
        else if (currentSurahIndex > 0) currentSurahIndex--;
        else currentSurahIndex = quranData.length - 1; // Wrap to last
        updateSurahSelection(currentSurahIndex);
    }
    
    function updateSurahSelection(index) {
        document.getElementById("surah-select").value = index;
        showSurah(index);
    }

    function showSurah(index) {
      audio.pause();
      audio.src = '';
      isPaused = false;
      document.body.classList.remove('is-playing');
      updatePauseButton(); // Set to 'Play'

      // Show audio player and enable nav buttons
      dom.audioPlayerBar.classList.add('visible');
      document.getElementById('prev-surah').disabled = false;
      document.getElementById('next-surah').disabled = false;

      const container = document.getElementById("verse-container");
      container.innerHTML = ""; // Clear random Ayah or previous Surah
      currentSurahIndex = index;
      selectedAyah = null;
      const surah = quranData[index];
      const surahUr = quranUrData[index];
      
      dom.audioStatus.textContent = `Ready to play ${surah.transliteration}`;

      surah.verses.forEach((verse,i) => {
        const ayahNumber = i + 1;
        const ayahDiv = document.createElement("div");
        ayahDiv.className = "ayah";
        ayahDiv.id = `ayah-${ayahNumber}`;
        ayahDiv.style.setProperty('--i', i); // For staggered animation
        
        ayahDiv.addEventListener('click', () => {
            const currentlySelected = document.querySelector('.ayah.selected');
            if (currentlySelected) currentlySelected.classList.remove('selected');
            
            if (currentlySelected !== ayahDiv) {
                ayahDiv.classList.add('selected');
                selectedAyah = ayahNumber;
            } else {
                selectedAyah = null; // Deselect
            }
        });

        const number = document.createElement("div");
        number.className = "verse-number";
        number.textContent = `(${surah.id}:${ayahNumber})`;

        const arabic = document.createElement("div");
arabic.className = "arabic";
        arabic.textContent = verse.text;

        const urdu = document.createElement("div");
        urdu.className = "urdu";
        urdu.textContent = surahUr.verses[i].translation;

        ayahDiv.appendChild(number);
        ayahDiv.appendChild(arabic);
        ayahDiv.appendChild(urdu);
        container.appendChild(ayahDiv);
      });
      
      if (showTranslation) {
        document.querySelectorAll(".urdu").forEach(el => el.style.display = "block");
      }
      
      // Scroll to top of Surah
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function playSurahAudio() {
      if (currentSurahIndex === -1) return;
      const surah = quranData[currentSurahIndex];
      const totalAyahs = surah.total_verses;
      currentAyah = selectedAyah || 1;
      isPaused = false;
      selectedAyah = null;

      clearAllHighlights();
      document.querySelector('.ayah.selected')?.classList.remove('selected');
      document.body.classList.add('is-playing');
      updatePauseButton();
      playAyah(currentAyah, surah.id, totalAyahs);
    }

    async function playAyah(ayahNo, surahNo, totalAyahs) {
      const audioId = `${surahNo}_${ayahNo}`;
      
      try {
        const cachedAudio = await getAudioFromCache(audioId);
        let audioUrl;

        if (cachedAudio) {
          audioUrl = URL.createObjectURL(cachedAudio);
          dom.audioStatus.textContent = `🔊 Playing (Cached): ${surahNo}:${ayahNo}`;
        } else {
          dom.audioStatus.innerHTML = `<div class="spinner"></div> Loading: ${surahNo}:${ayahNo}`;
          const url = `https://the-quran-project.github.io/Quran-Audio/Data/${reciterNo}/${audioId}.mp3`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const blob = await response.blob();
          await saveAudioToCache(audioId, blob);
          audioUrl = URL.createObjectURL(blob);
        }

        audio.src = audioUrl;
        audio.play().then(() => {
          dom.audioStatus.textContent = `🔊 Playing: ${surahNo}:${ayahNo}`;
          highlightAyah(ayahNo);
        }).catch((playError) => {
            console.error("Audio play error:", playError);
            dom.audioStatus.textContent = `⚠️ Playback error`;
        });

      } catch (error) {
        console.error('Error fetching/playing audio:', error);
        dom.audioStatus.textContent = `⚠️ Network/Cache Error`;
      }

      audio.onended = () => {
        unhighlightAyah(ayahNo);
        if (audio.src.startsWith('blob:')) {
            URL.revokeObjectURL(audio.src); // Clean up
        }
        if (!isPaused && ayahNo < totalAyahs) {
          currentAyah++;
          playAyah(currentAyah, surahNo, totalAyahs);
        } else if (ayahNo === totalAyahs) {
          dom.audioStatus.textContent = `✅ Surah Complete`;
          document.body.classList.remove('is-playing');
          updatePauseButton();
          isPaused = false;
        }
      };

      audio.onerror = () => {
          dom.audioStatus.textContent = `⚠️ Audio Element Error`;
          if (audio.src.startsWith('blob:')) URL.revokeObjectURL(audio.src);
      }
    }

    function togglePause() {
        if (!audio.src) return;
        if (audio.paused) {
            audio.play();
            isPaused = false;
            dom.audioStatus.textContent = `🔊 Playing: ${quranData[currentSurahIndex].id}:${currentAyah}`;
        } else {
            audio.pause();
            isPaused = true;
            dom.audioStatus.textContent = `⏸️ Paused: ${quranData[currentSurahIndex].id}:${currentAyah}`;
        }
        updatePauseButton();
    }

    function updatePauseButton() {
        if (audio.paused) {
            dom.pauseResumeBtn.innerHTML = icons.play;
            dom.pauseResumeBtn.title = "Resume";
        } else {
            dom.pauseResumeBtn.innerHTML = icons.pause;
            dom.pauseResumeBtn.title = "Pause";
        }
    }

    function highlightAyah(ayahNo) {
      clearAllHighlights();
      const el = document.getElementById(`ayah-${ayahNo}`);
      if (el) {
        el.classList.add("playing");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    function unhighlightAyah(ayahNo) {
      const el = document.getElementById(`ayah-${ayahNo}`);
      if (el) el.classList.remove("playing");
    }

    function clearAllHighlights() {
      document.querySelectorAll(".ayah.playing").forEach(el => {
        el.classList.remove("playing");
      });
    }
  </script>
</body>
</html>
